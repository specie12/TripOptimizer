// =============================================================================
// TripOptimizer Database Schema
// =============================================================================
// Budget-first travel planning application
// Tech Stack: PostgreSQL + Prisma ORM
//
// Design Principles:
// - Anonymous users first (no auth required for MVP)
// - Immutable TripRequests represent planning intent
// - Budget logic is deterministic and external to AI
// - Claude-generated content stored but never trusted for calculations
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

/// Travel style affects budget allocation percentages
/// Phase 7: Extended to support MID_RANGE and LUXURY
enum TravelStyle {
  BUDGET    // Cost-conscious travelers
  MID_RANGE // Mid-range comfort with good value
  BALANCED  // Mix of comfort and value (internal use)
  LUXURY    // Premium experiences and high-end accommodations
}

/// Budget categories for 6-way budget allocation (Phase 1)
enum BudgetCategory {
  FLIGHT      // Airfare and flight-related costs
  HOTEL       // Accommodation costs
  ACTIVITY    // Tours, attractions, experiences
  FOOD        // Meals and dining
  TRANSPORT   // Ground transportation (car rental, trains, local)
  CONTINGENCY // Emergency buffer and unexpected costs
}

/// Lock status for preventing re-optimization of confirmed bookings (Phase 2)
enum LockStatus {
  UNLOCKED  // Can be re-optimized or changed
  LOCKED    // User-selected, protected from re-optimization
  CONFIRMED // Booking confirmed, immutable
}

/// Activity categories for Phase 3
enum ActivityCategory {
  TOUR           // Guided tours, walking tours, city tours
  ATTRACTION     // Museums, landmarks, monuments
  EXPERIENCE     // Food tours, cooking classes, cultural experiences
  ADVENTURE      // Hiking, water sports, outdoor activities
  ENTERTAINMENT  // Shows, concerts, theater
  TRANSPORT      // Day trips, transfers, special transport
}

/// Trip pace preference for Phase 7
enum TripPace {
  RELAXED  // 2-3 activities per day
  BALANCED // 4-5 activities per day
  PACKED   // 6+ activities per day
}

/// Accommodation type preference for Phase 7
enum AccommodationType {
  HOTELS   // Traditional hotels
  AIRBNB   // Airbnb/vacation rentals
  RESORTS  // All-inclusive resorts
  HOSTELS  // Budget hostels
}

/// User interest categories for Phase 7
enum InterestCategory {
  CULTURE_HISTORY    // Culture & History
  FOOD_DINING        // Food & Dining
  ADVENTURE          // Adventure activities
  BEACH_RELAXATION   // Beach & Relaxation
  NIGHTLIFE          // Nightlife & Entertainment
  NATURE_WILDLIFE    // Nature & Wildlife
  SHOPPING           // Shopping
  ART_MUSEUMS        // Art & Museums
}

/// Types of user interactions tracked for analytics
/// MVP: Basic tracking for future personalization
enum InteractionType {
  VIEW_TRIP_OPTION    // User viewed a trip option
  EXPAND_EXPLANATION  // User expanded AI explanation
  CLICK_BOOK_FLIGHT   // User clicked flight booking link
  CLICK_BOOK_HOTEL    // User clicked hotel booking link
  CHANGE_HOTEL        // User selected different hotel option
}

// =============================================================================
// MODELS
// =============================================================================

/// User model for tracking anonymous users
/// MVP: Anonymous users only - no authentication
/// STEP 5: Supports passive personalization via inferred preferences
model User {
  id                 String   @id @default(uuid()) @db.Uuid
  createdAt          DateTime @default(now())
  lastSeenAt         DateTime @updatedAt

  // Personalization fields (STEP 5)
  // Populated by analyzing user behavior - used for tie-breaking only
  inferredBudgetBand   String?  // e.g., "low", "medium", "high"
  confidenceScore      Float    @default(0) // 0-1 confidence in inferred preferences
  totalInteractions    Int      @default(0) // Count of all interactions for confidence calc
  inferredPreferences  Json?    // { budgetSensitivity, comfortPreference, destinationStyles }

  // Relations
  tripRequests       TripRequest[]
  interactionEvents  InteractionEvent[]
}

/// Represents one immutable travel planning request
/// Core entity that captures user's travel intent
/// Each request can generate 2-3 TripOptions
model TripRequest {
  id           String      @id @default(uuid()) @db.Uuid

  // User association (nullable for anonymous users)
  userId       String?     @db.Uuid
  user         User?       @relation(fields: [userId], references: [id])

  // Travel details
  originCity   String      // Where the user is traveling from
  destination  String?     // Nullable: user may want suggestions
  startDate    DateTime?   // Nullable: flexible dates
  endDate      DateTime?   // Nullable: flexible dates
  numberOfDays Int         // Trip duration in days

  // Budget (stored in cents to avoid floating-point issues)
  budgetTotal  Int         // Total budget in cents (e.g., 100000 = $1,000)
  travelStyle  TravelStyle @default(BALANCED) // Determines budget allocation percentages

  // Phase 1: User preferences and constraints
  priorities   Json?       // { "flight": 1, "hotel": 2, "activities": 3, "food": 4, "transport": 5, "contingency": 6 }
  constraints  Json?       // { "mustHave": [], "mustAvoid": [], "preferences": {} }

  // Phase 7: Enhanced travel preferences
  tripPace          TripPace?            // Desired activity density per day
  accommodationType AccommodationType?   // Preferred lodging type
  interests         InterestCategory[]   // User's travel interests (multi-select)

  createdAt    DateTime    @default(now())

  // Relations
  tripOptions  TripOption[]
  budgetAllocations BudgetAllocation[]
  spendRecords SpendRecord[] // Phase 5: Track actual spending

  @@index([userId])
}

/// A generated travel option for a TripRequest
/// Each TripRequest generates 2-3 of these
/// Contains AI-generated content (explanation, itinerary)
model TripOption {
  id              String   @id @default(uuid()) @db.Uuid

  // Parent relation
  tripRequestId   String   @db.Uuid
  tripRequest     TripRequest @relation(fields: [tripRequestId], references: [id], onDelete: Cascade)

  // Option details
  destination     String   // The destination for this option

  // Cost breakdown (all in cents)
  totalCost       Int      // Sum of flight + hotel costs
  remainingBudget Int      // budgetTotal - totalCost (for activities)

  // AI-generated content (stored but not trusted for calculations)
  score           Float    // Option ranking score (0-1)
  explanation     String   @db.Text // Claude-generated explanation
  itineraryJson   Json     // Structured itinerary data

  // Phase 2: Lock-down mechanism
  lockStatus      LockStatus @default(UNLOCKED) // Protection from re-optimization
  lockedAt        DateTime?  // When this option was locked

  createdAt       DateTime @default(now())

  // Relations (1:1 with FlightOption and HotelOption, 1:many with ActivityOptions)
  flightOption    FlightOption?
  hotelOption     HotelOption?
  activityOptions ActivityOption[] // Phase 3: Multiple activities per trip
  interactionEvents InteractionEvent[]
  bookings        Booking[]        // Phase 2: Actual bookings
  payments        Payment[]        // Phase 2: Payment transactions

  @@index([tripRequestId])
  @@index([lockStatus])
}

/// Flight booking option for a TripOption
/// Exactly one FlightOption per TripOption (1:1 relation)
model FlightOption {
  id            String   @id @default(uuid()) @db.Uuid

  // 1:1 relation with TripOption (unique constraint enforces this)
  tripOptionId  String   @unique @db.Uuid
  tripOption    TripOption @relation(fields: [tripOptionId], references: [id], onDelete: Cascade)

  // Flight details
  provider      String   // Airline or booking provider name
  price         Int      // Price in cents
  departureTime DateTime // Outbound flight departure
  returnTime    DateTime // Return flight departure
  deepLink      String   // Direct booking URL

  // Phase 2: Lock-down mechanism for individual flight booking
  lockStatus    LockStatus @default(UNLOCKED) // Protection from re-optimization
  lockedAt      DateTime?  // When this flight was locked

  createdAt     DateTime @default(now())

  @@index([lockStatus])
}

/// Hotel booking option for a TripOption
/// Exactly one HotelOption per TripOption (1:1 relation)
model HotelOption {
  id           String   @id @default(uuid()) @db.Uuid

  // 1:1 relation with TripOption (unique constraint enforces this)
  tripOptionId String   @unique @db.Uuid
  tripOption   TripOption @relation(fields: [tripOptionId], references: [id], onDelete: Cascade)

  // Hotel details
  name         String   // Hotel name
  priceTotal   Int      // Total price for entire stay in cents
  rating       Float?   // Star rating (nullable if unavailable)
  deepLink     String   // Direct booking URL

  // Phase 2: Lock-down mechanism for individual hotel booking
  lockStatus   LockStatus @default(UNLOCKED) // Protection from re-optimization
  lockedAt     DateTime?  // When this hotel was locked

  createdAt    DateTime @default(now())

  @@index([lockStatus])
}

/// Activity booking option for a TripOption (Phase 3)
/// Multiple activities per TripOption (1:many relation)
model ActivityOption {
  id              String           @id @default(uuid()) @db.Uuid

  // Many-to-one relation with TripOption
  tripOptionId    String           @db.Uuid
  tripOption      TripOption       @relation(fields: [tripOptionId], references: [id], onDelete: Cascade)

  // Activity details
  name            String           // Activity name
  category        ActivityCategory // Type of activity
  description     String           @db.Text // Detailed description
  duration        Int              // Duration in minutes
  price           Int              // Price in cents

  // Optional fields
  rating          Float?           // Star rating (nullable if unavailable)
  reviewCount     Int?             // Number of reviews
  deepLink        String           // Direct booking URL
  imageUrl        String?          // Activity image

  // Availability
  availableFrom   DateTime?        // Start of availability window
  availableTo     DateTime?        // End of availability window

  // Phase 2: Lock-down mechanism for individual activity booking
  lockStatus      LockStatus       @default(UNLOCKED) // Protection from re-optimization
  lockedAt        DateTime?        // When this activity was locked

  createdAt       DateTime         @default(now())

  @@index([tripOptionId])
  @@index([category])
  @@index([lockStatus])
}

/// Tracks user interactions for analytics and future personalization
/// MVP: Basic event logging
/// FUTURE: Used by ML models to infer user preferences
model InteractionEvent {
  id           String          @id @default(uuid()) @db.Uuid

  // Optional associations (user may be anonymous, event may not be trip-specific)
  userId       String?         @db.Uuid
  user         User?           @relation(fields: [userId], references: [id])

  tripOptionId String?         @db.Uuid
  tripOption   TripOption?     @relation(fields: [tripOptionId], references: [id], onDelete: SetNull)

  // Event data
  eventType    InteractionType
  metadata     Json?           // Additional event-specific data

  createdAt    DateTime        @default(now())

  @@index([userId])
  @@index([tripOptionId])
  @@index([eventType])
}

/// Configuration for budget allocation by travel style
/// Deterministic percentages - not AI-generated
/// Phase 1: Extended to support 6 budget categories
model BudgetConfig {
  id          String      @id @default(uuid()) @db.Uuid

  // Unique per travel style (only one config per style)
  travelStyle TravelStyle @unique

  // Phase 1: 6-category budget allocation percentages (as decimals, e.g., 0.35 = 35%)
  // NOTE: These should sum to ~1.0 (100%)
  flightPct      Float       // Percentage for flights
  hotelPct       Float       // Percentage for hotels
  activityPct    Float       // Percentage for activities/attractions
  foodPct        Float       // Percentage for meals
  transportPct   Float       // Percentage for ground transportation
  contingencyPct Float       // Emergency buffer percentage

  createdAt   DateTime    @default(now())
}

/// Tracks budget allocation per category for a trip request (Phase 1)
/// Enables real-time budget tracking and spend monitoring
model BudgetAllocation {
  id              String         @id @default(uuid()) @db.Uuid
  tripRequestId   String         @db.Uuid
  tripRequest     TripRequest    @relation(fields: [tripRequestId], references: [id], onDelete: Cascade)

  category        BudgetCategory // Which category this allocation is for
  allocated       Int            // Amount allocated in cents
  spent           Int            @default(0) // Amount spent so far in cents

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([tripRequestId, category])
  @@index([tripRequestId])
}

/// Records actual spending against budget categories (Phase 5)
/// Enables real-time spend tracking and budget alerts
model SpendRecord {
  id            String         @id @default(uuid()) @db.Uuid
  tripRequestId String         @db.Uuid
  tripRequest   TripRequest    @relation(fields: [tripRequestId], references: [id], onDelete: Cascade)

  category      BudgetCategory // Which category this spend belongs to
  amount        Int            // Amount spent in cents
  description   String         @db.Text // What was purchased/booked
  recordedAt    DateTime       @default(now()) // When the spend occurred

  createdAt     DateTime       @default(now())

  @@index([tripRequestId])
  @@index([category])
  @@index([recordedAt])
}

/// Tracks actual bookings made through the system (Phase 2)
/// Implements booking state machine and rollback logic
model Booking {
  id                String         @id @default(uuid()) @db.Uuid
  tripOptionId      String         @db.Uuid
  tripOption        TripOption     @relation(fields: [tripOptionId], references: [id], onDelete: Cascade)

  // Booking metadata
  bookingType       String         // FLIGHT, HOTEL, ACTIVITY
  componentId       String         @db.Uuid // References FlightOption/HotelOption/ActivityOption

  // Booking status and state
  status            String         // PENDING, CONFIRMED, CANCELLED, FAILED
  state             String         @default("PENDING") // Booking state machine state

  // Confirmation details
  vendorConfirmation String?       // Vendor's confirmation code
  bookingReference   String?       // Our internal booking reference
  pnr                String?       // Passenger Name Record (flights only)

  // Payment tracking
  paymentIntentId    String?       // Stripe payment intent ID
  amount             Int           // Amount paid in cents
  currency           String        @default("USD")

  // Timestamps
  bookedAt           DateTime?     // When the booking was confirmed
  cancelledAt        DateTime?     // When the booking was cancelled

  // Booking details (JSON for flexibility)
  bookingDetails     Json?         // Full confirmation details

  // Error tracking
  error              String?       @db.Text // Error message if failed

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([tripOptionId])
  @@index([status])
  @@index([bookingType])
}

/// Tracks payment transactions for bookings (Phase 2)
/// Enables refunds and payment tracking
model Payment {
  id                String    @id @default(uuid()) @db.Uuid
  tripOptionId      String    @db.Uuid
  tripOption        TripOption @relation(fields: [tripOptionId], references: [id], onDelete: Cascade)

  // Stripe payment details
  paymentIntentId   String    @unique // Stripe payment intent ID
  chargeId          String?   // Stripe charge ID
  amount            Int       // Amount in cents
  currency          String    @default("USD")
  status            String    // succeeded, pending, failed, refunded

  // Refund tracking
  refundId          String?   // Stripe refund ID if refunded
  refundAmount      Int?      // Amount refunded in cents
  refundedAt        DateTime? // When refunded

  // Metadata
  paymentMethodId   String?   // Stripe payment method ID
  billingDetails    Json?     // Billing information

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tripOptionId])
  @@index([paymentIntentId])
  @@index([status])
}
